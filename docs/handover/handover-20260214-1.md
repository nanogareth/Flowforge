# Session Handover — 2026-02-14 #1

## Status

- **Branch:** main
- **Last commit:** 337f043 fix: resolve bundling and tooling issues for mobile app
- **Uncommitted changes:** Full Obsidian import flow implementation + auth bugfixes (see below)
- **Tests:** typecheck passes (0 errors); jest tests blocked by hook (run manually)

## What Was Done

### Obsidian Import Flow (Plan from `docs/architecture/mossy-gathering-whale.md`)

- **Phase 1 — Types + Frontmatter Parser:**
  - Extended `lib/types.ts` with `PickedFile`, `FrontmatterResult`, `contextFile?` on `CreateRepoOptions`, `id?` on `CreatedRepo`
  - Created `lib/frontmatter.ts` — `parseFrontmatter()` (regex YAML parser with defaults) and `filenameToRepoName()`
  - Created `__tests__/frontmatter.test.ts` — 20 tests covering edge cases

- **Phase 2 — Dependencies:**
  - Installed `expo-document-picker@14.0.8` via `npx expo install`

- **Phase 3 — Claude Code GitHub App Integration:**
  - Created `lib/claude-code-app.ts` — `findClaudeCodeInstallation()`, `enableClaudeCodeForRepo()`, `setupClaudeCode()`
  - Created `__tests__/claude-code-app.test.ts` — 7 tests with mocked Octokit

- **Phase 4 — Repository Creation:**
  - Modified `lib/github.ts` — added `contextFile` injection into repo, `repo.id` capture, `## Project Context` CLAUDE.md section
  - Fixed `Buffer` → `toBase64()` (Buffer doesn't exist in React Native)
  - Fixed `auto_init: false` → `auto_init: true` (GitHub Git Data API requires non-empty repo for blob creation)
  - Updated commit flow: get initial commit SHA → create tree → commit with parent → updateRef

- **Phase 5 — State Management:**
  - Modified `stores/store.ts` — added `claudeCodeEnabled`, `claudeCodeError`, `setClaudeCodeState()`, `resetCreationState()`

- **Phase 6 — Screens:**
  - Created `app/(app)/pick.tsx` — 4-phase state machine (idle → picked → creating → error), document picker, frontmatter parsing, editable fields
  - Modified `app/(app)/index.tsx` — two-card home: "Import from Obsidian" (primary) + "Create Manually" (secondary)
  - Modified `app/(app)/success.tsx` — Claude Code status section, "Open Claude Code" CTA, updated Quick Start
  - Modified `app/(app)/_layout.tsx` — registered `pick` screen

### Auth Bugfixes (pre-existing issues discovered during testing)

- **`.env` TOKEN_ENDPOINT** was missing `/api/auth/token` path — user must fix manually (protected file)
- **Backend redirect_uri validation** — expanded to accept `exp://` (Expo Go) in addition to `flowforge://`
- **PKCE support** — added `code_verifier` passthrough: `login.tsx` → `auth.ts` → backend → GitHub
- **Error visibility** — `login.tsx` catch block was swallowing errors silently; now surfaces them on screen
- **Copyable errors** — created `components/CopyableError.tsx`, used in login, pick, and create screens
- **Dev redirect URI display** — login screen shows redirect URI in dev mode for GitHub OAuth setup
- **Backend deployed** 3 times to Vercel production (`flowforge-api.vercel.app`) with cumulative fixes

### Other

- Created placeholder PNG assets (`assets/icon.png`, `splash.png`, `adaptive-icon.png`, `favicon.png`)

## Decisions Made

- **`expo-file-system` new API** — Used `new File(uri).text()` instead of deprecated `readAsStringAsync()` (SDK 54 removed legacy EncodingType export)
- **Post-hoc context injection** — Context file and CLAUDE.md section injected in `github.ts` after `composeTemplate()`, keeping template system untouched
- **`auto_init: true`** — GitHub's Git Data API (blobs) requires a non-empty repo; initial README commit is overwritten by template commit
- **PKCE flow** — Expo's `useAuthRequest` enables PKCE by default; backend now forwards `code_verifier` to GitHub
- **Stable Vercel URL** — Production backend at `https://flowforge-api.vercel.app`, NOT per-deployment hash URLs (those have deployment protection)

## Open Issues

- **Claude Code GitHub App integration not tested end-to-end** — The `setupClaudeCode()` function runs after repo creation but the actual GitHub App (`github.com/apps/claude`) integration (finding installation, adding repo) hasn't been verified on a real account with the app installed
- **Success screen "Open Claude Code" button** — Opens `https://claude.ai/code` in browser. User wants to work on the Claude Code web integration next
- **Tests not run** — Hook blocks test execution from Claude Code; need manual `npm test` to verify all 27+ tests pass
- **Partial repos from failed attempts** — User may have leftover repos on GitHub from earlier failed creation attempts that need manual cleanup
- **Dev-only redirect URI display** — `login.tsx` shows redirect URI at bottom in dev mode; should be removed or hidden before production

## Next Steps

1. **Claude Code web integration** — User's stated next priority. Needs investigation into what "Claude Code on the web" integration means beyond the current "Open Claude Code" button + GitHub App enablement
2. **Run tests manually** — `cd flowforge-mobile && npm test` to verify all tests pass
3. **Clean up dev helpers** — Remove redirect URI display from login screen before release
4. **Commit all changes** — Large uncommitted changeset ready to be committed
5. **Delete test repos** — Clean up any partial/test repos created during debugging on GitHub
