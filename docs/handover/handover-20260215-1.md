# Session Handover — 2026-02-15 #1

## Status

- **Branch:** main
- **Last commit:** 7cd3bff chore: add explorations, obsidian import plan, update codebase map
- **Uncommitted changes:** Full remote terminal feature (server + mobile integration) — not yet committed
- **Tests:** Not run this session (new server package has no tests yet; mobile typecheck passes clean)

## What Was Done

### Remote Terminal Server (`flowforge-server/` — new package)

- Created complete Node.js/TypeScript server package with Express + WebSocket
- **Auth system:** JWT with auto-generated secret key (`~/.flowforge-server/secret.key`), 6-digit pairing codes (single-use, 10min expiry), rate-limited pairing endpoint (5/min)
- **Terminal system:** node-pty sessions with WebSocket JSON protocol, 50KB scrollback ring buffer, multi-client broadcast, max 5 concurrent sessions, 30-min inactivity GC
- **Clone route:** POST /api/clone with NDJSON streaming progress, URL validation, optional `claude` launch in cloned dir
- **Server startup:** Prints pairing code banner, listens on 0.0.0.0:7433

### Mobile Integration (`flowforge-mobile/`)

- **New libs:** `lib/server-auth.ts` (SecureStore credentials, pairing, health check), `lib/server-api.ts` (clone & launch client), `lib/terminal-html.ts` (self-contained xterm.js HTML)
- **Store changes:** Added homeServerUrl, homeServerToken, isServerConnected state + actions; initialize() loads server creds on startup; logout() preserves server connection
- **New screens:** `server/pair.tsx` (URL + 6-digit code pairing), `server/index.tsx` (status + terminal + disconnect), `server/terminal.tsx` (WebView with xterm.js)
- **Existing screen integration:** Home shows Terminal card (connected) or Connect card (not configured); Success screen shows "Clone & Launch on Server" button when server connected
- **Layout:** Added server screen routes, removed stale `create` entry

### Verification

- `tsc --noEmit` passes clean for both flowforge-server and flowforge-mobile (0 errors each)

## Decisions Made

- **Express v5** used for server (latest available via npm install)
- **JWT expiry** set to 365 days (numeric seconds, not string — avoids `@types/jsonwebtoken` StringValue issue)
- **Pairing code** is single-use and 10-min expiry — regenerated on server restart
- **Server credentials persist across GitHub logout** — independent auth concern
- **xterm.js loaded from CDN** (jsDelivr) in WebView — avoids bundling in React Native
- **Android double-Enter debounce** (50ms) in terminal HTML to handle input duplication

## Open Issues

- **No tests for server package** — should add unit tests for auth, pairing, session-manager
- **No tests for mobile server libs** — server-auth.ts, terminal-html.ts need test coverage
- **node-pty native compilation** — may need `node-gyp` + build tools on target machine; not tested on Linux yet
- **Express v5 CORS** — using manual headers instead of `cors` package; consider switching
- **Tailscale assumption** — server binds 0.0.0.0 but docs should note Tailscale-only access is expected
- **Large uncommitted diff** — includes prior session changes mixed in; consider selective staging

## Next Steps

1. **Commit the remote terminal feature** (selective staging — server package + mobile changes)
2. **Add server tests** — auth/jwt, pairing, session-manager, clone validation
3. **Add mobile tests** — server-auth, terminal-html
4. **Test on actual device** — pair flow, terminal WebView, clone+launch
5. **Linux testing** — verify node-pty compiles, shell defaults to bash
6. **Documentation** — add server setup instructions (README or docs/)
7. **Consider Tailscale integration** — auto-discover server IP via Tailscale API
